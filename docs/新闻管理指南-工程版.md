# 内容工程指南（工程版）

面向工程同学，涵盖构建脚本、数据产物、前端 Hook、字段适配与排障流程。目标：确保 `content/` → `scripts/build-*.js` → `src/data/**/generated-*.json` → Hook → 页面渲染 的链路稳定可控。

---

## 一、数据管线与目录

```
content/*/*.md               # 作者写作源（Front Matter + 正文）
   ↓ gray-matter
scripts/build-*.js          # 构建脚本（解析 markdown，输出 JSON）
   ↓
src/data/**/generated-*.json # 生成的静态数据
   ↓
src/data/**/index.ts        # default* 导出
   ↓
src/hooks/useContent.ts     # use* Hooks 返回数据
   ↓
src/pages/* / src/components/*
```

- 构建脚本：
  - `scripts/build-ai-news.js`
  - `scripts/build-projects.js`
  - `scripts/build-designs.js`
  - `scripts/build-videos.js`

- 生成产物：
  - `src/data/ai/generated-news.json`
  - `src/data/projects/generated-projects.json`
  - `src/data/designs/generated-designs.json`
  - `src/data/videos/generated-videos.json`

- 默认导出索引：
  - `src/data/ai/news.ts` → `defaultNewsItems`
  - `src/data/projects/index.ts` → `defaultProjects`
  - `src/data/designs/index.ts` → `defaultDesigns`
  - `src/data/videos/index.ts` → `defaultVideos`

---

## 二、构建命令与钩子

`package.json`：
```json
{
  "scripts": {
    "dev": "npm run build:content && vite",
    "build": "npm run build:content && vite build",
    "build:content": "node scripts/build-ai-news.js && node scripts/build-projects.js && node scripts/build-designs.js && node scripts/build-videos.js"
  }
}
```

常用：
```
npm run build:content   # 解析 content，生成 JSON
npm run dev             # 生成后启动开发服务器
npm run build           # 生成后打包
```

---

## 三、前端接入（Hooks）

`src/hooks/useContent.ts`：
- `useNews()` → `defaultNewsItems`
- `useProjects()` → `defaultProjects`
- `useDesigns()` → `defaultDesigns`
- `useVideos()` → `defaultVideos`

类型补充（已适配 UI 可选字段）：
```ts
interface Project {
  id: string;
  slug?: string;
  title: string;
  description: string;
  technologies: string[];
  githubUrl?: string;
  demoUrl?: string;
  videoUrl?: string;
  thumbnail?: string; // 兼容旧 UI
  publishDate: string;
  category: string;
  isRecommended: boolean;
  isHighlight: boolean;
  coverImage?: string;
  content?: string;
  figmaUrl?: string;
}

interface Design {
  id: string;
  title: string;
  description: string;
  category: string;
  publishDate: string;
  coverImage?: string;
  // 兼容旧 UI 可选字段
  thumbnail?: string;
  tools?: string[];
  figmaUrl?: string;
  downloadUrl?: string;
  images?: string[];
}
```

---

## 四、页面改造要点

- 设计：
  - `src/pages/Designs.tsx` / `DesignDetails.tsx` → 使用 `useDesigns()`
  - 卡片封面使用 `coverImage`，无 `images` 时详情页回退到 `coverImage`

- 项目：
  - `src/pages/Portfolio.tsx` / `ProjectDetails.tsx` → 使用 `useProjects()`
  - 详情页 README：优先请求 GitHub README，失败回退 `project.content || project.description`

- 视频：
  - `src/pages/Videos.tsx` / `VideoDetails.tsx` → 使用 `useProjects()`（保留 `videoMeta`）
  - 列表封面使用 `coverImage`

- 搜索：
  - `src/components/SearchBar.tsx`：设计改为 `useDesigns()`；项目走 `getAllProjects()`（已接入 `defaultProjects`）

---

## 五、构建脚本关键点

- `gray-matter` 解析 Front Matter + 正文
- 排序：按 `publishDate` 降序
- 输出前确保目标目录存在（`fs.mkdirSync(dir, { recursive: true })`）
- 缺目录时打印警告并跳过（不抛错中断）

---

## 六、故障排除（工程向）

- **构建后页面未更新**：
  - 重启 dev，或强刷浏览器：`Ctrl+Shift+R`
  - 清理 Vite 预构建缓存：删除 `node_modules/.vite`

- **脚本报错 `MODULE_NOT_FOUND`**：
  - 确认脚本路径与 `package.json` 的 `build:content` 一致
  - 确认目标脚本文件已经存在

- **类型错误 / 字段缺失**：
  - 补充 `useContent.ts` 中的接口可选字段，或在页面使用可选链/回退

- **旧数据混用**：
  - 确认已删除：`public/data/news.json`、`src/data/news.json`
  - 搜索并移除 `fetch('/data/*.json')` 方式，统一使用静态导入 + Hook

---

## 七、扩展新内容类型（模板）

1) 设计 Front Matter → 在 `content/<type>/` 新建示例 `.md`
2) 编写 `scripts/build-<type>.js`：解析为 `src/data/<type>/generated-<type>.json`
3) 新增 `src/data/<type>/index.ts`：`export const default<Type> = generated`
4) `src/hooks/useContent.ts` 增加 `use<Type>()`
5) 页面/组件改造为使用新 Hook

---

## 八、提交前检查清单

- `npm run build:content` 是否成功、产物是否生成
- 页面是否均使用 Hook（无 `../content/*`、无 `fetch('/data/*.json')`）
- 关键字段是否回退处理到位（`coverImage`、`content` 等）
- 文档是否更新（作者版 & 工程版）
