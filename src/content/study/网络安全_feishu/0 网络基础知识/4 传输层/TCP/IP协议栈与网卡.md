# TCP/IP协议栈与网卡

TCP数据包

SYN表示建立连接，

FIN表示关闭连接，

ACK表示响应，

PSH表示有 DATA数据传输，

RST表示连接重置


# TCP工作过程

## 创建套接字

一般地，服务器方的应用程序在启动时就会创建好套接字并进入等待连接的状态；而客户端则一般是在用户触发了特定动作并且需要访问服务器的时候才创建。

## 连接服务器

创建套接字以后，客户端会向服务器发起连接操作。

1. 首先，客户端会生成一个SYN：1的TCP包并发送给服务器（①）（TCP包头还包括了客户端向服务器发送数据时使用的初始序号，以及服务器向客户端发送数据时用到的窗口大小）
2. 包到达服务器后，服务器会返回一个SYN：1的TCP包（②）（序号＋窗口大小+ACK号表示确认已收到包）
3. 包到达客户端后，客户端会向服务器返回一个TCP包（③）（包含确认ACK号）

![](assets/NDF4bPMpmoCWESxhFigcW3Jbn2g.png)

## 收发数据

1. 客户端向服务器发送消息 ④（TCP将请求消息分块，每块加上TCP头部，头部包含序号）
2. 服务器收到数据时，向客户端发送ACK号（⑤）
3. 起初，服务器只是不断接收数据，随着数据的收发，数据不断传给应用程序，接收缓冲区被逐步释放
4. 服务器需将新的窗口大小告知客户端
5. 服务器收到客户端的请求消息后，返回响应消息（⑥⑦）

## 从服务器断开并删除套接字

### 数据发送完毕后断开连接

请求消息——响应消息 完成数据发送的一方发起断开过程，以服务器方发起断开过程为例

1. 服务器方的应用程序调用Socket库的close程序
2. 服务器的协议栈生成包含断开信息的TCP头部（将控制位中的FIN比特设为1）
3. 协议栈委托TP模块向客户端发送数据
4. 客户端收到服务器发来的TCP包（FIN：1）
5. 协议栈委托IP模块向客户端发送数据（①）
6. 客户端的协议栈标记自己的套接字进入断开操作状态
7. 向服务器返回一个ACK号（②）
8. 应用程序调用read读取数据
9. 协议栈会告知应用程序来自服务器的数据已全部收到
10. 只要收到服务器返回的所有数据，客户端的应用程序会调用close来结束数据收发操作
11. 客户端的协议栈生成一个TCP包（FIN：1），委托IP模块发送给服务器（③）
12. 一段时间后，服务器返回ACK号（④）

![](assets/IAsrbod6KoWL0nxWmv5cV8jKnwh.png)

### 删除套接字

和服务器通信结束后，套接字即可删除，但为了避免误操作（操作顺序变化），不会立即删除

等待时间与包重传的操作方式有关

## IP与以太网的包收发操作

### 网络包的基本知识

1. 包是由头部和数据两部分构成，头部包含目的地址等控制信息

### IP包头分析与静态路由

### IP数据包格式

IP包头的长度： 20-60个字节

可选项可有可无

IP分片技术

流量清洗

## 题目

1．表示网络包收件人的接收方IP地址是位于IP头部还是TCP头部中呢？

2．端口号用来指定服务器程序的种类，那么它位于TCP头部还是IP头部中呢？

3．会对包是否正确送达进行确认的是TCP还是IP呢？

4．根据IP地址查询MAC地址的机制叫什么？

1. 收到ACK号之前继续发送下一个包的方式叫什么？
